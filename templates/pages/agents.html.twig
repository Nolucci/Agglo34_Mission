{% extends './base.html.twig' %}

{% block title %}Gestion des Utilisateurs{% endblock %}

{% block body %}
    <div class="page-wrapper">
        <div class="page-container">
            <div class="main-content">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card">
                                    <div class="card-header">
                                        <strong class="card-title">Gestion des Utilisateurs</strong>
                                        {% if isAdmin %}
                                            <button class="btn btn-sm btn-info float-right ml-2" data-toggle="modal" data-target="#whitelistModal">
                                                <i class="fa fa-list"></i> Gérer la Whitelist
                                            </button>
                                        {% endif %}
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Nom</th>
                                                        <th>Email</th>
                                                        <th>Nom d'utilisateur LDAP</th>
                                                        <th>Rôles</th>
                                                        <th>Dernière connexion</th>
                                                        {% if isAdmin %}
                                                            <th>Actions</th>
                                                        {% endif %}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for agent in agents %}
                                                    <tr>
                                                        <td>{{ agent.name }}</td>
                                                        <td>{{ agent.email }}</td>
                                                        <td>{{ agent.ldapUsername ?? 'N/A' }}</td>
                                                        <td>
                                                            {% for role in agent.roles %}
                                                                {% if role == 'ROLE_ADMIN' %}
                                                                    <span class="badge badge-danger">Administrateur</span>
                                                                {% elseif role == 'ROLE_MODIFIEUR' %}
                                                                    <span class="badge badge-warning">Modifieur</span>
                                                                {% elseif role == 'ROLE_VISITEUR_TOUT' %}
                                                                    <span class="badge badge-info">Visiteur - Tout</span>
                                                                {% elseif role == 'ROLE_VISITEUR_LIGNES' %}
                                                                    <span class="badge badge-secondary">Visiteur - Lignes</span>
                                                                {% elseif role == 'ROLE_VISITEUR_PARC' %}
                                                                    <span class="badge badge-secondary">Visiteur - Parc</span>
                                                                {% elseif role == 'ROLE_VISITEUR_BOXS' %}
                                                                    <span class="badge badge-secondary">Visiteur - Boxs</span>
                                                                {% elseif role == 'ROLE_DISABLED' %}
                                                                    <span class="badge badge-dark">Désactivé</span>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </td>
                                                        <td>
                                                            {% if agent.lastLoginAt %}
                                                                {{ agent.lastLoginAt|date('d/m/Y H:i') }}
                                                            {% else %}
                                                                <span class="text-muted">Jamais</span>
                                                            {% endif %}
                                                        </td>
                                                        {% if isAdmin %}
                                                            <td>
                                                                <button class="btn btn-sm btn-primary edit-roles-btn"
                                                                        data-id="{{ agent.id }}"
                                                                        data-name="{{ agent.name }}"
                                                                        data-roles="{{ agent.roles|json_encode }}"
                                                                        data-toggle="modal"
                                                                        data-target="#editRolesModal">
                                                                    <i class="fa fa-edit"></i> Modifier les rôles
                                                                </button>
                                                            </td>
                                                        {% endif %}
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if isAdmin %}
        <!-- Modal pour modifier les rôles -->
        <div class="modal fade" id="editRolesModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modifier les rôles</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editRolesForm">
                            <input type="hidden" id="userId" name="userId">
                            <div class="form-group">
                                <label>Utilisateur :</label>
                                <span id="userName" class="font-weight-bold"></span>
                            </div>
                            <div class="form-group">
                                <label>Rôles :</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" value="ROLE_ADMIN" id="roleAdmin">
                                    <label class="form-check-label" for="roleAdmin">Administrateur</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" value="ROLE_MODIFIEUR" id="roleModifieur">
                                    <label class="form-check-label" for="roleModifieur">Modifieur</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" value="ROLE_VISITEUR_TOUT" id="roleVisiteurTout">
                                    <label class="form-check-label" for="roleVisiteurTout">Visiteur - Tout</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" value="ROLE_VISITEUR_LIGNES" id="roleVisiteurLignes">
                                    <label class="form-check-label" for="roleVisiteurLignes">Visiteur - Lignes Téléphoniques</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" value="ROLE_VISITEUR_PARC" id="roleVisiteurParc">
                                    <label class="form-check-label" for="roleVisiteurParc">Visiteur - Parc Informatique</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" value="ROLE_VISITEUR_BOXS" id="roleVisiteurBoxs">
                                    <label class="form-check-label" for="roleVisiteurBoxs">Visiteur - Boxs</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="role" value="ROLE_DISABLED" id="roleDisabled">
                                    <label class="form-check-label" for="roleDisabled">Désactivé</label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary" id="saveRoles">Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>

    {% endif %}

    {% if isAdmin %}
        <!-- Modal pour gérer la whitelist -->
        <div class="modal fade" id="whitelistModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Gestion de la Whitelist</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Ajouter un utilisateur</h6>
                                <form id="addToWhitelistForm">
                                    <div class="form-group">
                                        <label for="ldapUsername">Nom d'utilisateur LDAP :</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="ldapUsername" name="ldapUsername" required>
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-outline-secondary" id="testLdapBtn">
                                                    <i class="fa fa-search"></i> Tester
                                                </button>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">Vérification automatique dans LDAP</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="userName">Nom complet :</label>
                                        <input type="text" class="form-control" id="userName" name="name">
                                        <small class="form-text text-muted">Sera récupéré automatiquement depuis LDAP si disponible</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="userEmail">Email :</label>
                                        <input type="email" class="form-control" id="userEmail" name="email">
                                        <small class="form-text text-muted">Sera récupéré automatiquement depuis LDAP si disponible</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="initialRole">Rôle initial :</label>
                                        <select class="form-control" id="initialRole" name="initialRole">
                                            <option value="ROLE_VISITEUR_TOUT">Visiteur - Tout</option>
                                            <option value="ROLE_VISITEUR_LIGNES">Visiteur - Lignes</option>
                                            <option value="ROLE_VISITEUR_PARC">Visiteur - Parc</option>
                                            <option value="ROLE_VISITEUR_BOXS">Visiteur - Boxs</option>
                                            <option value="ROLE_MODIFIEUR">Modifieur</option>
                                            <option value="ROLE_ADMIN">Administrateur</option>
                                        </select>
                                    </div>

                                    <div id="ldapTestResult" class="alert" style="display: none;"></div>

                                    <button type="submit" class="btn btn-success">
                                        <i class="fa fa-plus"></i> Ajouter
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <h6>Utilisateurs autorisés</h6>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Nom d'utilisateur LDAP</th>
                                                <th>Nom</th>
                                                <th>Email</th>
                                                <th>Statut</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="whitelistTable">
                                            <!-- Contenu chargé dynamiquement -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="whitelistLoading" class="text-center">
                                    <i class="fa fa-spinner fa-spin"></i> Chargement...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function() {
            // Gestion de l'édition des rôles
            $('.edit-roles-btn').on('click', function() {
                const userId = $(this).data('id');
                const userName = $(this).data('name');
                const roles = $(this).data('roles');

                $('#userId').val(userId);
                $('#userName').text(userName);

                // Décocher tous les rôles
                $('input[name="role"]').prop('checked', false);

                // Cocher le rôle principal (le plus élevé dans la hiérarchie)
                if (roles.includes('ROLE_DISABLED')) {
                    $('#roleDisabled').prop('checked', true);
                } else if (roles.includes('ROLE_ADMIN')) {
                    $('#roleAdmin').prop('checked', true);
                } else if (roles.includes('ROLE_MODIFIEUR')) {
                    $('#roleModifieur').prop('checked', true);
                } else if (roles.includes('ROLE_VISITEUR_TOUT')) {
                    $('#roleVisiteurTout').prop('checked', true);
                } else if (roles.includes('ROLE_VISITEUR_LIGNES')) {
                    $('#roleVisiteurLignes').prop('checked', true);
                } else if (roles.includes('ROLE_VISITEUR_PARC')) {
                    $('#roleVisiteurParc').prop('checked', true);
                } else if (roles.includes('ROLE_VISITEUR_BOXS')) {
                    $('#roleVisiteurBoxs').prop('checked', true);
                }
            });

            // Sauvegarder les rôles
            $('#saveRoles').on('click', function() {
                const userId = $('#userId').val();
                const selectedRole = $('input[name="role"]:checked').val();

                if (!selectedRole) {
                    alert('Veuillez sélectionner un rôle');
                    return;
                }

                $.ajax({
                    url: '/user/update-role',
                    method: 'POST',
                    data: {
                        userId: userId,
                        role: selectedRole
                    },
                    success: function(response) {

                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Erreur : ' + response.message);
                        }
                    },
                    error: function() {
                        alert('Erreur lors de la mise à jour des rôles');
                    }
                });
            });

            // Gestion de la modal whitelist
            $('#whitelistModal').on('show.bs.modal', function() {
                loadWhitelistUsers();
            });

            // Charger la liste des utilisateurs de la whitelist
            function loadWhitelistUsers() {
                $('#whitelistLoading').show();
                $('#whitelistTable').empty();

                $.ajax({
                    url: '/admin/whitelist/api/users',
                    method: 'GET',
                    success: function(response) {
                        $('#whitelistLoading').hide();
                        if (response.success) {
                            updateWhitelistTable(response.users);
                        } else {
                            alert('Erreur lors du chargement : ' + response.message);
                        }
                    },
                    error: function() {
                        $('#whitelistLoading').hide();
                        alert('Erreur lors du chargement de la whitelist');
                    }
                });
            }

            // Mettre à jour le tableau de la whitelist
            function updateWhitelistTable(users) {
                const tbody = $('#whitelistTable');
                tbody.empty();

                if (!users || users.length === 0) {
                    const emptyRow = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                Aucun utilisateur dans la whitelist
                            </td>
                        </tr>
                    `;
                    tbody.append(emptyRow);
                    return;
                }

                users.forEach(function(user) {
                    const statusBadge = !user.is_active ?
                        '<span class="badge badge-dark">Désactivé</span>' :
                        '<span class="badge badge-success">Actif</span>';

                    const actionButtons = !user.is_active ?
                        `<button class="btn btn-xs btn-success reactivate-user mr-1" data-username="${user.ldap_username}" title="Réactiver">
                            <i class="fa fa-check"></i>
                        </button>
                        <button class="btn btn-xs btn-danger remove-user" data-username="${user.ldap_username}" title="Supprimer">
                            <i class="fa fa-trash"></i>
                        </button>` :
                        `<button class="btn btn-xs btn-warning disable-user mr-1" data-username="${user.ldap_username}" title="Désactiver">
                            <i class="fa fa-ban"></i>
                        </button>
                        <button class="btn btn-xs btn-danger remove-user" data-username="${user.ldap_username}" title="Supprimer">
                            <i class="fa fa-trash"></i>
                        </button>`;

                    const row = `
                        <tr data-username="${user.ldap_username}" class="${!user.is_active ? 'table-secondary' : ''}">
                            <td><strong>${user.ldap_username}</strong></td>
                            <td>${user.name || '-'}</td>
                            <td>${user.email || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${actionButtons}
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }

            // Test LDAP
            $('#testLdapBtn').on('click', function() {
                const username = $('#ldapUsername').val();
                if (!username) {
                    alert('Veuillez saisir un nom d\'utilisateur');
                    return;
                }

                const btn = $(this);
                const originalText = btn.html();
                btn.html('<i class="fa fa-spinner fa-spin"></i> Test...');
                btn.prop('disabled', true);

                $.ajax({
                    url: '/admin/whitelist/test-ldap-user',
                    method: 'POST',
                    data: { ldapUsername: username },
                    success: function(data) {
                        const resultDiv = $('#ldapTestResult');
                        resultDiv.show();

                        if (data.success && data.user_exists) {
                            resultDiv.removeClass('alert-warning alert-danger').addClass('alert-success');
                            resultDiv.html('<i class="fa fa-check"></i> ' + data.message);

                            // Remplir automatiquement les champs
                            if (data.user_info) {
                                if (data.user_info.name) {
                                    $('#userName').val(data.user_info.name);
                                }
                                if (data.user_info.email) {
                                    $('#userEmail').val(data.user_info.email);
                                }
                            }
                        } else {
                            resultDiv.removeClass('alert-success alert-danger').addClass('alert-warning');
                            resultDiv.html('<i class="fa fa-exclamation-triangle"></i> ' + data.message);
                        }
                    },
                    error: function() {
                        const resultDiv = $('#ldapTestResult');
                        resultDiv.show();
                        resultDiv.removeClass('alert-success alert-warning').addClass('alert-danger');
                        resultDiv.html('<i class="fa fa-times"></i> Erreur lors du test LDAP');
                    },
                    complete: function() {
                        btn.html(originalText);
                        btn.prop('disabled', false);
                    }
                });
            });

            // Ajouter un utilisateur à la whitelist
            $('#addToWhitelistForm').on('submit', function(e) {
                e.preventDefault();

                const formData = {
                    ldapUsername: $('#ldapUsername').val(),
                    name: $('#userName').val(),
                    email: $('#userEmail').val(),
                    role: $('#initialRole').val()
                };

                $.ajax({
                    url: '/admin/whitelist/api/add',
                    method: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            $('#addToWhitelistForm')[0].reset();
                            $('#ldapTestResult').hide();
                            loadWhitelistUsers();
                            alert('Utilisateur ajouté avec succès');
                        } else {
                            alert('Erreur : ' + response.message);
                        }
                    },
                    error: function() {
                        alert('Erreur lors de l\'ajout de l\'utilisateur');
                    }
                });
            });

            // Désactiver un utilisateur
            $(document).on('click', '.disable-user', function() {
                const username = $(this).data('username');

                if (confirm('Voulez-vous vraiment désactiver cet utilisateur ?')) {
                    $.ajax({
                        url: '/admin/whitelist/api/disable',
                        method: 'POST',
                        data: { ldapUsername: username },
                        success: function(response) {
                            if (response.success) {
                                loadWhitelistUsers();
                                alert('Utilisateur désactivé');
                            } else {
                                alert('Erreur : ' + response.message);
                            }
                        },
                        error: function() {
                            alert('Erreur lors de la désactivation');
                        }
                    });
                }
            });

            // Réactiver un utilisateur
            $(document).on('click', '.reactivate-user', function() {
                const username = $(this).data('username');

                $.ajax({
                    url: '/admin/whitelist/api/reactivate',
                    method: 'POST',
                    data: { ldapUsername: username },
                    success: function(response) {
                        if (response.success) {
                            loadWhitelistUsers();
                            alert('Utilisateur réactivé');
                        } else {
                            alert('Erreur : ' + response.message);
                        }
                    },
                    error: function() {
                        alert('Erreur lors de la réactivation');
                    }
                });
            });

            // Supprimer un utilisateur
            $(document).on('click', '.remove-user', function() {
                const username = $(this).data('username');

                if (confirm('Voulez-vous vraiment supprimer définitivement cet utilisateur de la whitelist ?')) {
                    $.ajax({
                        url: '/admin/whitelist/api/remove',
                        method: 'POST',
                        data: { ldapUsername: username },
                        success: function(response) {
                            if (response.success) {
                                loadWhitelistUsers();
                                alert('Utilisateur supprimé');
                            } else {
                                alert('Erreur : ' + response.message);
                            }
                        },
                        error: function() {
                            alert('Erreur lors de la suppression');
                        }
                    });
                }
            });

        });
    </script>
{% endblock %}
