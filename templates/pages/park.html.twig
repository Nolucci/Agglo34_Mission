{% extends './base.html.twig' %}

{% block title %}Informations du Parc Informatique{% endblock %}

{% block body %}
<div class="page-wrapper">
    <div class="page-container">
        <div class="main-content">
            <div class="section__content section__content--p30">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="card">
                                <div class="card-header">
                                    <strong class="card-title">Statistiques du Parc</strong>
                                </div>
                                <div class="card-body" style="min-height: 300px;">
                                    <ul class="list-unstyled">
                                        <li>
                                            <i class="fas fa-desktop"></i> Total des équipements :
                                            <span class="badge badge-primary">{{ equipments|length }}</span>
                                        </li>
                                        <li>
                                            <i class="fas fa-building"></i> Services uniques :
                                            <span class="badge badge-info">{{ parkStats.unique_services }}</span>
                                        </li>
                                        <li>
                                            <i class="fas fa-building"></i> Municipalités uniques :
                                            <span class="badge badge-success">{{ parkStats.unique_municipalities }}</span>
                                        </li>
                                        <li>
                                            <i class="fas fa-check-circle"></i> Équipements actifs :
                                            <span class="badge badge-warning">{{ parkStats.active_equipments }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3">
                            <div class="card">
                                <div class="card-header">
                                    <strong class="card-title">Statistiques des Équipements</strong>
                                </div>
                                <div class="card-body" style="min-height: 300px;">
                                    <canvas id="team-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3">
                            <div class="card">
                                <div class="card-header">
                                    <strong class="card-title">Équipements par Statut</strong>
                                </div>
                                <div class="card-body" style="min-height: 300px;">
                                    <canvas id="status-doughnut-chart"></canvas>
                                </div>
                            </div>
                        </div>

                         <div class="col-lg-3">
                             <div class="card">
                                <div class="card-header">
                                    <strong class="card-title">Carte des Équipements</strong>
                                </div>
                                <div class="card-body" style="min-height: 300px;">
                                    <div id="map-agglomeration" style="height: 300px; width: 100%; border: 1px solid #ccc;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <strong class="card-title">Liste des Équipements Informatiques</strong>
                                    <button class="btn btn-sm btn-primary float-right" data-toggle="modal" data-target="#parkFiltersModal">
                                        <i class="fa fa-filter"></i> Filtres
                                    </button>
                                </div>
                                <div class="card-body" style="min-height: 300px;">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Type</th>
                                                    <th>Marque</th>
                                                    <th>Modèle</th>
                                                    <th>Attribué à</th>
                                                    <th>Localisation</th>
                                                    <th>Municipalité</th>
                                                    <th>Statut</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for equipment in equipments %}
                                                <tr>
                                                    <td>{{ equipment.type }}</td>
                                                    <td>{{ equipment.brand }}</td>
                                                    <td>{{ equipment.model }}</td>
                                                    <td>{{ equipment.assignedTo }}</td>
                                                    <td>{{ equipment.location }}</td>
                                                    <td>{{ equipment.municipality }}</td>
                                                    <td>
                                                        {% if equipment.isActive %}
                                                            <span class="badge badge-success">Actif</span>
                                                        {% else %}
                                                            <span class="badge badge-secondary">Inactif</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# {% include './modals/_park_filters_modal.html.twig' with { equipments: equipments } %} #}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/park-map.js') }}"></script>
    <script>
        const allEquipments = {{ equipments | json_encode | raw }};
        let displayedEquipments = [...allEquipments];

        // Team Commits Chart
        var ctxTeam = document.getElementById("team-chart");
        if (ctxTeam) {
            ctxTeam.height = 150;
            var myChartTeam = new Chart(ctxTeam, {
                type: 'bar',
                data: {
                    labels: {{ teamChartData.labels | json_encode | raw }},
                    type: 'bar',
                    defaultFontFamily: 'Poppins',
                    datasets: [{
                        data: {{ teamChartData.data | json_encode | raw }},
                        label: "Équipements par Type",
                        backgroundColor: 'rgba(0,103,255,.15)',
                        borderColor: 'rgba(0,103,255,0.5)',
                        borderWidth: 3.5,
                        pointStyle: 'circle',
                        pointRadius: 5,
                        pointBorderColor: 'transparent',
                        pointBackgroundColor: 'rgba(0,103,255,0.5)',
                    },]
                },
                options: {
                    responsive: true,
                    tooltips: {
                        mode: 'index',
                        titleFontSize: 12,
                        titleFontColor: '#000',
                        bodyFontColor: '#000',
                        backgroundColor: '#fff',
                        titleFontFamily: 'Poppins',
                        bodyFontFamily: 'Poppins',
                        cornerRadius: 3,
                        intersect: false,
                    },
                    legend: {
                        display: false,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            fontFamily: 'Poppins',
                        },
                    },
                    scales: {
                        xAxes: [{
                            display: true,
                            gridLines: {
                                display: false,
                                drawBorder: false
                            },
                            scaleLabel: {
                                display: false,
                                labelString: 'Month'
                            },
                            ticks: {
                                fontFamily: "Poppins"
                            }
                        }],
                        yAxes: [{
                            display: true,
                            gridLines: {
                                display: false,
                                drawBorder: false
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Value',
                                fontFamily: "Poppins"
                            },
                            ticks: {
                                fontFamily: "Poppins"
                            }
                        }]
                    },
                    title: {
                        display: false,
                    }
                }
            });
        }

        // Status Doughnut Chart
        var ctxStatus = document.getElementById("status-doughnut-chart");
        if (ctxStatus) {
            ctxStatus.height = 150; // Ajustez la hauteur si nécessaire
            var myChartStatus = new Chart(ctxStatus, {
                type: 'bar',
                data: {
                    datasets: [{
                        data: {{ statusChartData.data | json_encode | raw }},
                        backgroundColor: [
                            "rgba(40, 167, 69, 0.9)", // Vert pour Actif
                            "rgba(108, 117, 125, 0.7)" // Gris pour Inactif
                        ],
                        hoverBackgroundColor: [
                            "rgba(40, 167, 69, 1)",
                            "rgba(108, 117, 125, 0.9)"
                        ],
                    }],
                    labels: {{ statusChartData.labels | json_encode | raw }}
                },
                options: {
                    legend: {
                        position: 'top',
                        labels: {
                            fontFamily: 'Poppins'
                        }
                    },
                    responsive: true
                }
            });
        }


        // Fonction pour rendre la table des équipements
        function renderEquipmentsTable(equipmentsToDisplay) {
            const tbody = document.querySelector('.table tbody'); // Assuming only one table for now
            tbody.innerHTML = ''; // Clear current table

            equipmentsToDisplay.forEach(equipment => {
                const row = `
                    <tr>
                        <td>${equipment.type}</td>
                        <td>${equipment.brand}</td>
                        <td>${equipment.model}</td>
                        <td>${equipment.assignedTo}</td>
                        <td>${equipment.location}</td>
                        <td>${equipment.municipality}</td>
                        <td>
                            ${equipment.isActive ? '<span class="badge badge-success">Actif</span>' : '<span class="badge badge-secondary">Inactif</span>'}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Initialisation de la carte des équipements
        function initMap() {
            // Logique de la carte à implémenter
        }

        // Initial render of the table
        document.addEventListener('DOMContentLoaded', function() {
            renderEquipmentsTable(displayedEquipments);
        });
    </script>
{% endblock %}
