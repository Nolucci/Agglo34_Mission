{% extends './base.html.twig' %}

{% block title %}Paramètres administrateur{% endblock %}

{% block body %}
    <div class="page-wrapper">
        <div class="page-container">
            <div class="main-content">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">

                        <div class="row">
                            <div class="col-lg-12">
                                <h3 class="title-5 m-b-35">Paramètres administrateur</h3>

                                <form method="post" action="{{ path('settings_save') }}">
                                    <!-- Section Configuration LDAP -->
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <i class="fas fa-users mr-2"></i>Configuration LDAP
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="ldap_enabled">Activer l'authentification LDAP</label>
                                                        <select class="form-control" id="ldap_enabled" name="ldap_enabled">
                                                            <option value="1" {% if settings is defined and settings.isLdapEnabled is defined and settings.isLdapEnabled %}selected{% endif %}>Activé</option>
                                                            <option value="0" {% if settings is not defined or settings.isLdapEnabled is not defined or not settings.isLdapEnabled %}selected{% endif %}>Désactivé</option>
                                                        </select>
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="ldap_host">Serveur LDAP</label>
                                                        <input type="text" class="form-control" id="ldap_host" name="ldap_host"
                                                               value="{{ settings.getLdapHost is defined ? settings.getLdapHost : '' }}"
                                                               placeholder="ex: 10.3.12.55">
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="ldap_port">Port LDAP</label>
                                                        <input type="number" class="form-control" id="ldap_port" name="ldap_port"
                                                               value="{{ settings.getLdapPort is defined ? settings.getLdapPort : 389 }}"
                                                               min="1" max="65535">
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="ldap_encryption">Chiffrement</label>
                                                        <select class="form-control" id="ldap_encryption" name="ldap_encryption">
                                                            <option value="none" {% if settings is defined and settings.getLdapEncryption is defined and settings.getLdapEncryption == 'none' %}selected{% endif %}>Aucun</option>
                                                            <option value="ssl" {% if settings is defined and settings.getLdapEncryption is defined and settings.getLdapEncryption == 'ssl' %}selected{% endif %}>SSL</option>
                                                            <option value="tls" {% if settings is defined and settings.getLdapEncryption is defined and settings.getLdapEncryption == 'tls' %}selected{% endif %}>TLS</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="ldap_base_dn">Base DN</label>
                                                        <textarea class="form-control" id="ldap_base_dn" name="ldap_base_dn" rows="2"
                                                                  placeholder="OU=_Listing Agents,OU=Agents,OU=Utilisateurs,OU=CABM,DC=beziers-agglo,DC=org">{{ settings.getLdapBaseDn is defined ? settings.getLdapBaseDn : '' }}</textarea>
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="ldap_search_dn">Search DN</label>
                                                        <textarea class="form-control" id="ldap_search_dn" name="ldap_search_dn" rows="2"
                                                                  placeholder="CN=agglo34_ldap,OU=LDAP_SYNCRO,OU=Applicatifs,OU=Utilisateurs,OU=CABM,DC=beziers-agglo,DC=org">{{ settings.getLdapSearchDn is defined ? settings.getLdapSearchDn : '' }}</textarea>
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="ldap_search_password">Mot de passe de recherche</label>
                                                        <input type="password" class="form-control" id="ldap_search_password" name="ldap_search_password"
                                                               value="{{ settings.getLdapSearchPassword is defined ? settings.getLdapSearchPassword : '' }}">
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="ldap_uid_key">Clé UID</label>
                                                        <input type="text" class="form-control" id="ldap_uid_key" name="ldap_uid_key"
                                                               value="{{ settings.getLdapUidKey is defined ? settings.getLdapUidKey : 'nomcompte' }}"
                                                               placeholder="nomcompte">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Boutons de test LDAP -->
                                            <div class="row mt-3">
                                                <div class="col-12">
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle mr-2"></i>
                                                        <strong>Test de connexion :</strong> Utilisez ces boutons pour tester votre configuration LDAP avant de l'activer.
                                                    </div>

                                                    <button type="button" class="btn btn-info mr-2" id="test-ldap-connection">
                                                        <i class="fas fa-plug mr-2"></i>Tester la connexion LDAP
                                                    </button>

                                                    <button type="button" class="btn btn-warning" id="test-ldap-user" data-toggle="modal" data-target="#testUserModal">
                                                        <i class="fas fa-user-check mr-2"></i>Tester l'authentification utilisateur
                                                    </button>

                                                    <div id="ldap-test-result" class="mt-3" style="display: none;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section Configuration Base de Données -->
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <i class="fas fa-database mr-2"></i>Configuration Base de Données
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label for="database_url">URL de connexion à la base de données</label>
                                                <input type="text" class="form-control" id="database_url" name="database_url"
                                                       value="{{ settings is defined and settings.getDatabaseUrl is defined ? settings.getDatabaseUrl : '' }}"
                                                       placeholder="postgresql://user:password@host:port/database">
                                                <small class="form-text text-muted">
                                                    Format: postgresql://utilisateur:motdepasse@serveur:port/base_de_donnees
                                                </small>
                                            </div>

                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle mr-2"></i>
                                                <strong>Information :</strong> Les modifications de la base de données nécessitent un redémarrage de l'application pour prendre effet.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section Mode Maintenance -->
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <i class="fas fa-tools mr-2"></i>Mode Maintenance
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group">
                                                <label for="maintenance_mode">Activer le mode maintenance</label>
                                                <select class="form-control" id="maintenance_mode" name="maintenance_mode">
                                                    <option value="1" {% if settings is defined and settings.isMaintenanceMode is defined and settings.isMaintenanceMode %}selected{% endif %}>Activé</option>
                                                    <option value="0" {% if settings is not defined or settings.isMaintenanceMode is not defined or not settings.isMaintenanceMode %}selected{% endif %}>Désactivé</option>
                                                </select>
                                                <small class="form-text text-muted">
                                                    En mode maintenance, seuls les administrateurs peuvent accéder à l'application.
                                                </small>
                                            </div>

                                            <div class="form-group">
                                                <label for="maintenance_message">Message de maintenance</label>
                                                <textarea class="form-control" id="maintenance_message" name="maintenance_message" rows="3"
                                                          placeholder="Message affiché aux utilisateurs pendant la maintenance">{{ settings is defined and settings.getMaintenanceMessage is defined ? settings.getMaintenanceMessage : 'Application en maintenance. Veuillez réessayer plus tard.' }}</textarea>
                                            </div>

                                            {% if settings is defined and settings.isMaintenanceMode is defined and settings.isMaintenanceMode %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                                <strong>Attention :</strong> Le mode maintenance est actuellement activé.
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>



                                    <!-- Boutons d'action -->
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <a href="{{ path('dashboard') }}" class="btn btn-secondary btn-lg">
                                                <i class="fas fa-arrow-left mr-2"></i>Retour au tableau de bord
                                            </a>
                                            <button type="submit" class="btn btn-success btn-lg mr-3">
                                                <i class="fas fa-save mr-2"></i>Enregistrer les paramètres
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour tester l'authentification utilisateur -->
    <div class="modal fade" id="testUserModal" tabindex="-1" role="dialog" aria-labelledby="testUserModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testUserModalLabel">Test d'authentification utilisateur</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="test-user-form">
                        <div class="form-group">
                            <label for="test-username">Nom d'utilisateur</label>
                            <input type="text" class="form-control" id="test-username" placeholder="Entrez le nom d'utilisateur à tester">
                        </div>
                        <div class="form-group">
                            <label for="test-password">Mot de passe</label>
                            <input type="password" class="form-control" id="test-password" placeholder="Entrez le mot de passe">
                        </div>
                        <div id="user-test-result"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" id="execute-user-test">Tester l'authentification</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Test de connexion LDAP
        document.getElementById('test-ldap-connection').addEventListener('click', function() {
            const button = this;
            const resultDiv = document.getElementById('ldap-test-result');

            // Désactiver le bouton et afficher le loading
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Test en cours...';

            // Récupérer les valeurs du formulaire
            const config = {
                host: document.getElementById('ldap_host').value,
                port: document.getElementById('ldap_port').value,
                encryption: document.getElementById('ldap_encryption').value,
                base_dn: document.getElementById('ldap_base_dn').value,
                search_dn: document.getElementById('ldap_search_dn').value,
                search_password: document.getElementById('ldap_search_password').value,
                uid_key: document.getElementById('ldap_uid_key').value
            };

            // Envoyer la requête de test
            fetch('{{ path('settings_test_ldap') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                // Afficher le résultat
                resultDiv.style.display = 'block';
                if (data.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle mr-2"></i>' + data.message + '</div>';
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle mr-2"></i>' + data.message + '</div>';
                }
            })
            .catch(error => {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle mr-2"></i>Erreur lors du test : ' + error.message + '</div>';
            })
            .finally(() => {
                // Réactiver le bouton
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-plug mr-2"></i>Tester la connexion LDAP';
            });
        });

        // Test d'authentification utilisateur
        document.getElementById('execute-user-test').addEventListener('click', function() {
            const button = this;
            const resultDiv = document.getElementById('user-test-result');
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;

            if (!username || !password) {
                resultDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle mr-2"></i>Veuillez saisir un nom d\'utilisateur et un mot de passe.</div>';
                return;
            }

            // Désactiver le bouton et afficher le loading
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Test en cours...';

            // Récupérer les valeurs du formulaire
            const config = {
                host: document.getElementById('ldap_host').value,
                port: document.getElementById('ldap_port').value,
                encryption: document.getElementById('ldap_encryption').value,
                base_dn: document.getElementById('ldap_base_dn').value,
                search_dn: document.getElementById('ldap_search_dn').value,
                search_password: document.getElementById('ldap_search_password').value,
                uid_key: document.getElementById('ldap_uid_key').value,
                username: username,
                password: password
            };

            // Envoyer la requête de test
            fetch('{{ path('settings_test_ldap_user') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                // Afficher le résultat
                if (data.success) {
                    let message = '<div class="alert alert-success"><i class="fas fa-check-circle mr-2"></i>' + data.message;
                    if (data.user_attributes) {
                        message += '<hr><strong>Attributs utilisateur :</strong><ul>';
                        for (const [key, value] of Object.entries(data.user_attributes)) {
                            message += '<li><strong>' + key + ':</strong> ' + value + '</li>';
                        }
                        message += '</ul>';
                    }
                    message += '</div>';
                    resultDiv.innerHTML = message;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle mr-2"></i>' + data.message + '</div>';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle mr-2"></i>Erreur lors du test : ' + error.message + '</div>';
            })
            .finally(() => {
                // Réactiver le bouton
                button.disabled = false;
                button.innerHTML = 'Tester l\'authentification';
            });
        });
    });
    </script>
{% endblock %}
