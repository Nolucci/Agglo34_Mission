{% extends 'base.html.twig' %}

{% block title %}Archives{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .action-buttons {
        white-space: nowrap;
    }
    .loading-spinner {
        text-align: center;
        padding: 20px;
        display: none;
    }
    .no-archives {
        text-align: center;
        padding: 20px;
        font-style: italic;
        color: #6c757d;
    }
    .json-data {
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .json-data:hover {
        white-space: normal;
        word-wrap: break-word;
    }
    .table th, .table td {
        vertical-align: middle;
    }
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .btn-group .btn {
        margin-right: 3px;
    }
</style>
{% endblock %}

{% block body %}
<div class="page-wrapper">
    <div class="page-container">
        <div class="main-content">
            <div class="section__content section__content--p30">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <strong class="card-title">Liste des Archives</strong>
                                    <button class="btn btn-sm btn-danger float-right ml-2" id="delete-all-archives">
                                        <i class="fa fa-trash"></i> Tout supprimer
                                    </button>
                                    <button class="btn btn-sm btn-primary float-right" data-toggle="modal" data-target="#archivesFiltersModal">
                                        <i class="fa fa-filter"></i> Filtres
                                    </button>
                                </div>
                                <div class="card-body" style="height: auto;">
                                    <div class="form-group">
                                        <label for="searchInput">Rechercher par attribut:</label>
                                        <input type="text" class="form-control" id="searchInput" placeholder="Entrez un terme de recherche">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th width="15%">Type d'Entité</th>
                                                    <th width="10%">ID Entité</th>
                                                    <th width="15%">Date d'Archivage</th>
                                                    <th width="45%">Données Archivées</th>
                                                    <th width="15%">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="archives-table-body">
                                                <!-- Les archives seront chargées ici via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="loading-spinner" class="loading-spinner">
                                        <i class="fa fa-spinner fa-spin fa-2x"></i>
                                        <p>Chargement des archives...</p>
                                    </div>
                                    <div id="no-archives" class="no-archives" style="display: none;">
                                        <p>Aucune archive trouvée.</p>
                                    </div>
                                    <div class="mt-3">
                                        <div id="load-more-container" class="text-center" style="display: none;">
                                            <button id="load-more-btn" class="btn btn-outline-primary">
                                                <i class="fa fa-refresh"></i> Charger plus
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include './modals/_archives_filters_modal.html.twig' %}

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteAllConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteAllConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAllConfirmModalLabel">Confirmation de suppression</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer définitivement toutes les archives ?</p>
                <p class="text-danger"><strong>Attention :</strong> Cette action est irréversible.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-all">Supprimer définitivement</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de restauration -->
<div class="modal fade" id="restoreConfirmModal" tabindex="-1" role="dialog" aria-labelledby="restoreConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restoreConfirmModalLabel">Confirmation de restauration</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir restaurer cette archive ?</p>
                <p>L'élément sera recréé dans sa table d'origine et supprimé des archives.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="confirm-restore">Restaurer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let hasMoreArchives = false;
    let isLoading = false;
    let archiveToRestore = null;
    let allArchives = [];
    let displayedArchives = [];

    // Fonction pour filtrer les archives par recherche
    document.getElementById('searchInput').addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();

        if (searchTerm.length === 0) {
            // Si le champ de recherche est vide, afficher toutes les archives
            displayedArchives = [...allArchives];
        } else {
            // Sinon, filtrer les archives
            displayedArchives = allArchives.filter(archive => {
                // Rechercher dans le type d'entité
                if (archive.entityType.toLowerCase().includes(searchTerm)) return true;

                // Rechercher dans l'ID d'entité
                if (archive.entityId.toString().includes(searchTerm)) return true;

                // Rechercher dans la date d'archivage
                if (archive.archivedAt.toLowerCase().includes(searchTerm)) return true;

                // Rechercher dans les données archivées (convertir en chaîne JSON)
                const dataString = JSON.stringify(archive.data).toLowerCase();
                if (dataString.includes(searchTerm)) return true;

                return false;
            });
        }

        // Mettre à jour l'affichage
        renderArchivesTable(displayedArchives);
    });

    // Fonction pour afficher les archives dans le tableau
    function renderArchivesTable(archives) {
        const tableBody = document.getElementById('archives-table-body');
        tableBody.innerHTML = '';

        if (archives.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <i class="fa fa-info-circle"></i> Aucune archive ne correspond à votre recherche.
                    </td>
                </tr>
            `;
            return;
        }

        archives.forEach(archive => {
            const row = document.createElement('tr');

            // Créer les cellules
            row.innerHTML = `
                <td>${archive.entityType}</td>
                <td>${archive.entityId}</td>
                <td>${archive.archivedAt}</td>
                <td class="json-data">${JSON.stringify(archive.data)}</td>
                <td class="action-buttons">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-success restore-archive" data-id="${archive.id}" title="Récupérer cette archive">
                            <i class="fa fa-undo"></i> Récupérer
                        </button>
                    </div>
                </td>
            `;

            tableBody.appendChild(row);
        });
    }

    // Fonction pour charger les archives
    function loadArchives(page = 1, append = false) {
        if (isLoading) return;

        isLoading = true;

        // Afficher le spinner de chargement
        if (!append) {
            document.getElementById('archives-table-body').innerHTML = '';
            document.getElementById('no-archives').style.display = 'none';
        }
        document.getElementById('loading-spinner').style.display = 'block';
        document.getElementById('load-more-container').style.display = 'none';

        // Récupérer les filtres actuels
        const urlParams = new URLSearchParams(window.location.search);
        const entityType = urlParams.get('entityType') || '';
        const startDate = urlParams.get('startDate') || '';
        const endDate = urlParams.get('endDate') || '';

        // Construire l'URL avec les paramètres
        let url = `{{ path('app_archive_load') }}?page=${page}`;
        if (entityType) url += `&entityType=${entityType}`;
        if (startDate) url += `&startDate=${startDate}`;
        if (endDate) url += `&endDate=${endDate}`;

        // Effectuer la requête AJAX
        fetch(url)
            .then(response => response.json())
            .then(data => {
                isLoading = false;
                document.getElementById('loading-spinner').style.display = 'none';

                if (data.archives.length === 0 && !append) {
                    document.getElementById('no-archives').style.display = 'block';
                    return;
                }

                // Mettre à jour les variables de pagination
                currentPage = page;
                hasMoreArchives = data.hasMore;

                // Stocker les archives
                if (append) {
                    allArchives = [...allArchives, ...data.archives];
                } else {
                    allArchives = [...data.archives];
                }

                displayedArchives = [...allArchives];

                // Afficher les archives
                renderArchivesTable(displayedArchives);

                // Afficher ou masquer le bouton "Charger plus"
                document.getElementById('load-more-container').style.display = hasMoreArchives ? 'block' : 'none';
            })
            .catch(error => {
                console.error('Erreur lors du chargement des archives:', error);
                isLoading = false;
                document.getElementById('loading-spinner').style.display = 'none';

                // Afficher un message d'erreur
                if (!append) {
                    document.getElementById('archives-table-body').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                <i class="fa fa-exclamation-triangle"></i> Une erreur est survenue lors du chargement des archives.
                            </td>
                        </tr>
                    `;
                }
            });
    }

    // Charger les archives au chargement de la page
    loadArchives();

    // Gérer le clic sur le bouton "Charger plus"
    document.getElementById('load-more-btn').addEventListener('click', function() {
        if (hasMoreArchives && !isLoading) {
            loadArchives(currentPage + 1, true);
        }
    });

    // Gérer le clic sur le bouton "Tout supprimer"
    document.getElementById('delete-all-archives').addEventListener('click', function() {
        $('#deleteAllConfirmModal').modal('show');
    });

    // Gérer la confirmation de suppression de toutes les archives
    document.getElementById('confirm-delete-all').addEventListener('click', function() {
        // Fermer le modal de confirmation
        $('#deleteAllConfirmModal').modal('hide');

        // Effectuer la requête AJAX pour supprimer toutes les archives
        fetch('{{ path('app_archive_delete_all') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher un message de succès
                alert(data.message);

                // Recharger les archives
                loadArchives();
            } else {
                // Afficher un message d'erreur
                alert(data.message || 'Une erreur est survenue lors de la suppression des archives.');
            }
        })
        .catch(error => {
            console.error('Erreur lors de la suppression des archives:', error);
            alert('Une erreur est survenue lors de la suppression des archives.');
        });
    });

    // Gérer le clic sur les boutons "Récupérer"
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('restore-archive') ||
            (event.target.parentElement && event.target.parentElement.classList.contains('restore-archive'))) {

            const button = event.target.classList.contains('restore-archive') ?
                event.target : event.target.parentElement;

            archiveToRestore = button.dataset.id;
            $('#restoreConfirmModal').modal('show');
        }
    });

    // Gérer la confirmation de restauration d'une archive
    document.getElementById('confirm-restore').addEventListener('click', function() {
        if (!archiveToRestore) return;

        // Fermer le modal de confirmation
        $('#restoreConfirmModal').modal('hide');

        // Effectuer la requête AJAX pour restaurer l'archive
        fetch(`{{ path('app_archive_restore', {'id': 'ARCHIVE_ID'}) }}`.replace('ARCHIVE_ID', archiveToRestore), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher un message de succès
                alert(data.message);

                // Recharger les archives
                loadArchives();
            } else {
                // Afficher un message d'erreur
                alert(data.message || 'Une erreur est survenue lors de la restauration de l\'archive.');
            }
        })
        .catch(error => {
            console.error('Erreur lors de la restauration de l\'archive:', error);
            alert('Une erreur est survenue lors de la restauration de l\'archive.');
        });

        // Réinitialiser l'ID de l'archive à restaurer
        archiveToRestore = null;
    });
});
</script>
{% endblock %}